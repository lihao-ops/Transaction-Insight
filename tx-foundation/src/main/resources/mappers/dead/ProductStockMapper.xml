<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.transactioninsight.foundation.deadlock.order_inventory.mapper.ProductStockMapper">

    <!-- ===================== ResultMap å®šä¹‰ ===================== -->

    <!--
        ProductStock å®Œæ•´å­—æ®µæ˜ å°„
        è§£å†³ä¸‹åˆ’çº¿å‘½å â†’ é©¼å³°å‘½åçš„æ˜ å°„é—®é¢˜
    -->
    <resultMap id="ProductStockMap" type="com.transactioninsight.foundation.deadlock.order_inventory.model.ProductStock">
        <id property="id" column="id"/>
        <result property="productCode" column="product_code"/>
        <result property="productName" column="product_name"/>
        <result property="productType" column="product_type"/>
        <result property="duration" column="duration"/>
        <result property="stockQuantity" column="stock_quantity"/>
        <result property="version" column="version"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- ===================== æŸ¥è¯¢æ–¹æ³• ===================== -->

    <!--
        ã€ä¼šå¯¼è‡´æ­»é”ã€‘æ— åºåŠ é”æŸ¥è¯¢åº“å­˜
        å®žéªŒç›®çš„ï¼šæ¨¡æ‹Ÿæ­»é”åœºæ™¯ï¼ŒæŒ‰ä¼ å…¥é¡ºåºåŠ é”
        é¢„æœŸçŽ°è±¡ï¼šå¹¶å‘æ—¶å‡ºçŽ° Deadlock found when trying to get lock

        æ­»é”åŽŸç†ï¼š
        - äº‹åŠ¡Aï¼šæŒ‰ [PRO_MONTH, LIMIT_UP_MONTH] é¡ºåºåŠ é”
        - äº‹åŠ¡Bï¼šæŒ‰ [LIMIT_UP_MONTH, PRO_MONTH] é¡ºåºåŠ é”
        - å½¢æˆå¾ªçŽ¯ç­‰å¾… â†’ æ­»é”
    -->
    <select id="selectByCodesForUpdateNoOrder" resultMap="ProductStockMap">
        SELECT
        id,
        product_code,
        product_name,
        product_type,
        duration,
        stock_quantity,
        version,
        created_at,
        updated_at
        FROM product_stock
        WHERE product_code = #{code}
        FOR UPDATE
        <!-- æ³¨æ„ï¼šæ²¡æœ‰ ORDER BYï¼ŒMySQL æŒ‰æŸ¥æ‰¾åˆ°çš„é¡ºåºåŠ é”ï¼ˆä¸ç¡®å®šæ€§ï¼‰ -->
    </select>

    <!--
        ã€è§£å†³æ­»é”ã€‘æœ‰åºåŠ é”æŸ¥è¯¢åº“å­˜
        å®žéªŒç›®çš„ï¼šé€šè¿‡ç»Ÿä¸€åŠ é”é¡ºåºé¿å…æ­»é”
        é¢„æœŸçŽ°è±¡ï¼šå¹¶å‘æ—¶æŒ‰ä¸»é”®å‡åºæŽ’é˜Ÿï¼Œä¸ä¼šæ­»é”

        æ ¸å¿ƒåŽŸç†ï¼š
        - ORDER BY id ASC å¼ºåˆ¶æ‰€æœ‰äº‹åŠ¡æŒ‰ç›¸åŒé¡ºåºåŠ é”
        - æ‰“ç ´å¾ªçŽ¯ç­‰å¾…æ¡ä»¶
        - äº‹åŠ¡åªèƒ½ä¸²è¡Œç­‰å¾…ï¼Œæ— æ³•å½¢æˆæ­»é”çŽ¯
    -->
    <!--å³ä½¿æ²¡æœ‰ ORDER BYï¼ŒInnoDB ä¹Ÿä¼šæŒ‰ç…§ç´¢å¼•é¡ºåºï¼ˆé€šå¸¸æ˜¯ä¸»é”® ASCï¼‰åŠ é”ã€‚å†™ ASC ä¸Žä¸å†™ ASCï¼Œæœ¬è´¨ä¸Šä¸å½±å“åŠ é”é¡ºåºï¼ˆå‰ææ˜¯ä½¿ç”¨ç´¢å¼•ï¼‰-->
    <select id="selectByCodesForUpdateOrdered" resultMap="ProductStockMap">
        SELECT
        id,
        product_code,
        product_name,
        product_type,
        duration,
        stock_quantity,
        version,
        created_at,
        updated_at
        FROM product_stock
        WHERE product_code IN
        <foreach collection="codes" item="code" open="(" separator="," close=")">
            #{code}
        </foreach>
        ORDER BY id ASC  <!-- ðŸ”‘ å…³é”®ï¼šå¼ºåˆ¶æŒ‰ä¸»é”®å‡åºåŠ é” -->
        FOR UPDATE
    </select>

    <!--
        æŸ¥è¯¢å½“å‰åº“å­˜ï¼ˆä¸åŠ é”ï¼‰
        ç”¨é€”ï¼šæµ‹è¯•éªŒè¯åº“å­˜æ‰£å‡æ˜¯å¦æ­£ç¡®
    -->
    <select id="getStock" resultType="java.lang.Integer">
        SELECT stock_quantity
        FROM product_stock
        WHERE product_code = #{code}
    </select>

    <!-- ===================== æ›´æ–°æ–¹æ³• ===================== -->

    <!--
        æ‰£å‡åº“å­˜ï¼ˆå¸¦åº“å­˜æ ¡éªŒï¼‰
        æ³¨æ„ï¼šæ­¤æ–¹æ³•å¿…é¡»åœ¨å·²åŠ è¡Œé”ï¼ˆFOR UPDATEï¼‰åŽè°ƒç”¨

        ä¹è§‚é”åŽŸç†ï¼š
        - WHERE æ¡ä»¶åŒ…å« stock_quantity >= #{quantity}
        - å¦‚æžœåº“å­˜ä¸è¶³ï¼Œupdate è¿”å›ž 0ï¼ˆå½±å“è¡Œæ•°ï¼‰
        - ä¸šåŠ¡å±‚æ£€æŸ¥è¿”å›žå€¼åˆ¤æ–­æ˜¯å¦æ‰£å‡æˆåŠŸ
    -->
    <update id="deductStock">
        UPDATE product_stock
        SET stock_quantity = stock_quantity - #{quantity}
        WHERE product_code = #{code}
          AND stock_quantity >= #{quantity}
    </update>

    <!--
        é‡ç½®åº“å­˜ï¼ˆæµ‹è¯•ç”¨ï¼‰
        ç”¨é€”ï¼šåœ¨æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹å‰é‡ç½®æ•°æ®
    -->
    <update id="resetStock">
        UPDATE product_stock
        SET stock_quantity = #{quantity}
        WHERE product_code = #{code}
    </update>

    <!--ä¹è§‚é”-->
    <!-- æŸ¥è¯¢åº“å­˜+ç‰ˆæœ¬ -->
    <select id="getStockWithVersion" resultMap="ProductStockMap">
        SELECT * FROM product_stock WHERE product_code = #{code}
    </select>

    <!-- ä¹è§‚é”æ‰£å‡ CAS -->
    <update id="deductStockOptimistic">
        UPDATE product_stock
        SET
            stock_quantity = stock_quantity - #{quantity},
            version = version + 1
        WHERE product_code = #{code}
          AND stock_quantity >= #{quantity}
          AND version = #{version}
    </update>

</mapper>